#!/bin/bash
#
# read-messages - Display messages from the collaboration channel
#
# Usage:
#   read-messages                    # Show last 10 messages
#   read-messages --all              # Show all messages
#   read-messages --last 20          # Show last 20 messages
#   read-messages --follow           # Continuously watch for new messages
#   read-messages --json             # Output raw JSON
#
# Environment:
#   COLLAB_SESSION - Session ID (or use --session)
#

set -e

COLLAB_DIR="/mnt/shared/collab"

# Defaults
SESSION="${COLLAB_SESSION:-}"
COUNT=10
ALL=false
FOLLOW=false
JSON_OUTPUT=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --session|-s)
            SESSION="$2"
            shift 2
            ;;
        --last|-n)
            COUNT="$2"
            shift 2
            ;;
        --all|-a)
            ALL=true
            shift
            ;;
        --follow|-f)
            FOLLOW=true
            shift
            ;;
        --json|-j)
            JSON_OUTPUT=true
            shift
            ;;
        --help|-h)
            echo "Usage: read-messages [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --session, -s SESSION   Session ID (or set COLLAB_SESSION)"
            echo "  --last, -n COUNT        Show last N messages (default: 10)"
            echo "  --all, -a               Show all messages"
            echo "  --follow, -f            Continuously watch for new messages"
            echo "  --json, -j              Output raw JSON"
            echo ""
            echo "Example:"
            echo "  export COLLAB_SESSION=mysession"
            echo "  read-messages --last 5"
            exit 0
            ;;
        -*)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

if [[ -z "$SESSION" ]]; then
    echo "Error: No session specified. Set COLLAB_SESSION or use --session" >&2
    exit 1
fi

CHANNEL_DIR="${COLLAB_DIR}/channels/${SESSION}"

if [[ ! -d "$CHANNEL_DIR" ]]; then
    echo "No messages yet in session '$SESSION'"
    exit 0
fi

# Colors
BLUE="\033[94m"
GREEN="\033[92m"
YELLOW="\033[93m"
GRAY="\033[90m"
RESET="\033[0m"
BOLD="\033[1m"

format_message() {
    local file="$1"

    if $JSON_OUTPUT; then
        cat "$file"
        return
    fi

    # Parse JSON and format
    local from=$(jq -r '.from // "unknown"' "$file")
    local text=$(jq -r '.content.text // ""' "$file")
    local code=$(jq -r '.content.code // empty' "$file")
    local timestamp=$(jq -r '.timestamp // ""' "$file")

    # Format timestamp
    local time_str
    if [[ -n "$timestamp" ]]; then
        time_str=$(date -d "$timestamp" +"%H:%M:%S" 2>/dev/null || echo "??:??:??")
    else
        time_str="??:??:??"
    fi

    # Color based on sender
    local color
    case $from in
        claude) color="$BLUE" ;;
        codex)  color="$GREEN" ;;
        human)  color="$YELLOW" ;;
        *)      color="$GRAY" ;;
    esac

    echo -e "${BOLD}${color}[${time_str}] ${from}${RESET}: ${text}"

    if [[ -n "$code" ]]; then
        echo '```'
        echo "$code"
        echo '```'
    fi
}

show_messages() {
    local files
    if $ALL; then
        files=$(ls -1 "$CHANNEL_DIR"/*.json 2>/dev/null | sort)
    else
        files=$(ls -1 "$CHANNEL_DIR"/*.json 2>/dev/null | sort | tail -n "$COUNT")
    fi

    if [[ -z "$files" ]]; then
        echo "No messages in session '$SESSION'"
        return
    fi

    for file in $files; do
        format_message "$file"
    done
}

if $FOLLOW; then
    echo -e "${GRAY}[Watching session '$SESSION' for new messages. Press Ctrl+C to stop]${RESET}"
    echo ""

    # Show existing messages first
    show_messages

    # Track what we've seen
    declare -A seen
    for file in "$CHANNEL_DIR"/*.json; do
        [[ -f "$file" ]] && seen["$(basename "$file")"]=1
    done 2>/dev/null

    # Watch for new files
    while true; do
        for file in "$CHANNEL_DIR"/*.json; do
            [[ -f "$file" ]] || continue
            basename=$(basename "$file")
            if [[ -z "${seen[$basename]}" ]]; then
                format_message "$file"
                seen["$basename"]=1
            fi
        done
        sleep 1
    done
else
    show_messages
fi
