#!/bin/bash
#
# collab-snapshot - Save a snapshot of a collaboration channel to the log server
#
# Usage:
#   collab-snapshot [channel]
#
# Saves both .log (plaintext) and .html (formatted) versions to ~/claude-logs/
# Viewable at http://claude:8090/
#

set -e

CHANNEL="${1:-${COLLAB_SESSION:-aqara-trv-automation}}"
CHANNEL_DIR="/mnt/shared/collab/channels/${CHANNEL}"
LOG_DIR="${HOME}/claude-logs"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BASE_NAME="collab-watch-${CHANNEL}_${TIMESTAMP}"

if [[ ! -d "$CHANNEL_DIR" ]]; then
    echo "Error: Channel '$CHANNEL' not found at $CHANNEL_DIR"
    exit 1
fi

mkdir -p "$LOG_DIR"

# Create plaintext .log file (for indexing)
LOG_FILE="${LOG_DIR}/${BASE_NAME}.log"

echo "Collaboration Session: ${CHANNEL}" > "$LOG_FILE"
echo "Snapshot: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> "$LOG_FILE"
echo "========================================" >> "$LOG_FILE"
echo "" >> "$LOG_FILE"

for file in $(ls -t "$CHANNEL_DIR"/msg-*.json 2>/dev/null | tac); do
    from=$(jq -r '.from // "unknown"' "$file")
    text=$(jq -r '.content.text // ""' "$file")
    timestamp=$(jq -r '.timestamp // ""' "$file")

    if [[ -n "$timestamp" ]]; then
        time_str=$(date -d "$timestamp" '+%H:%M:%S' 2>/dev/null || echo "$timestamp")
    else
        time_str=""
    fi

    echo "[${from}] ${time_str}" >> "$LOG_FILE"
    echo "$text" >> "$LOG_FILE"
    echo "" >> "$LOG_FILE"
done

# Create HTML version (for display)
HTML_FILE="${LOG_DIR}/${BASE_NAME}.html"

cat > "$HTML_FILE" << 'HEADER'
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Collab Watch</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', monospace;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 { color: #00d4aa; }
        .header {
            background: #16213e;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #00d4aa;
        }
        .message {
            margin: 15px 0;
            padding: 10px 15px;
            border-radius: 8px;
            background: #16213e;
        }
        .claude { border-left: 4px solid #60a5fa; }
        .codex { border-left: 4px solid #34d399; }
        .human { border-left: 4px solid #fbbf24; }
        .gemini { border-left: 4px solid #a78bfa; }
        .from { font-weight: bold; margin-bottom: 5px; }
        .from.claude { color: #60a5fa; }
        .from.codex { color: #34d399; }
        .from.human { color: #fbbf24; }
        .from.gemini { color: #a78bfa; }
        .time { color: #888; font-size: 0.85em; margin-left: 10px; }
        .text { white-space: pre-wrap; line-height: 1.5; }
    </style>
</head>
<body>
HEADER

# Add header with channel name and timestamp
cat >> "$HTML_FILE" << EOF
    <div class="header">
        <h1>Collaboration Session: ${CHANNEL}</h1>
        <p>Snapshot: $(date '+%Y-%m-%d %H:%M:%S UTC')</p>
        <p>
            <span style="color:#60a5fa">● Claude</span> &nbsp;
            <span style="color:#34d399">● Codex</span> &nbsp;
            <span style="color:#fbbf24">● Human</span> &nbsp;
            <span style="color:#a78bfa">● Gemini</span>
        </p>
    </div>
EOF

for file in $(ls -t "$CHANNEL_DIR"/msg-*.json 2>/dev/null | tac); do
    from=$(jq -r '.from // "unknown"' "$file")
    text=$(jq -r '.content.text // ""' "$file")
    timestamp=$(jq -r '.timestamp // ""' "$file")

    case $from in
        claude*) css_class="claude" ;;
        codex*)  css_class="codex" ;;
        human*)  css_class="human" ;;
        gemini*) css_class="gemini" ;;
        *)       css_class="" ;;
    esac

    if [[ -n "$timestamp" ]]; then
        time_str=$(date -d "$timestamp" '+%H:%M:%S' 2>/dev/null || echo "$timestamp")
    else
        time_str=""
    fi

    # Escape HTML
    escaped_text=$(echo "$text" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')

    cat >> "$HTML_FILE" << MSG
    <div class="message ${css_class}">
        <div class="from ${css_class}">${from}<span class="time">${time_str}</span></div>
        <div class="text">${escaped_text}</div>
    </div>
MSG
done

echo "</body></html>" >> "$HTML_FILE"

# Ensure HTML is newer than log so server uses it
touch "$HTML_FILE"

MSG_COUNT=$(ls -1 "$CHANNEL_DIR"/msg-*.json 2>/dev/null | wc -l)

echo "Snapshot saved: ${BASE_NAME}"
echo "  Messages: ${MSG_COUNT}"
echo "  Log:  ${LOG_FILE}"
echo "  HTML: ${HTML_FILE}"
echo ""
echo "View at: http://claude:8090/log/${BASE_NAME}.log"
