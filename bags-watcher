#!/bin/bash
#
# bags-watcher - Bag Analysis Specialist agent watcher
#
# Uses Claude Sonnet for bag journey analysis:
# - Timeline reconstruction
# - BHS troubleshooting
# - RP1745 message parsing
# - Root cause analysis
#
# Usage:
#   bags-watcher <channel>
#
# Run in tmux:
#   tmux new-session -d -s bags-watcher '/mnt/shared/collab/scripts/bags-watcher agent-os-paper'
#

set -e

CHANNEL="${1:-agent-os-paper}"
CHANNEL_DIR="/mnt/shared/collab/channels/${CHANNEL}"
PRESENCE_DIR="/mnt/shared/collab/presence"
SCRIPTS_DIR="/mnt/shared/collab/scripts"
AGENT="bags-1"
LOG_FILE="/mnt/shared/collab/logs/bags-watcher.log"
BAGDB_DIR="/home/graeme/bagdatabase"
BAGDB_TOOLS="/home/graeme/bagdb-tools/scripts"

# Colors for terminal output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
NC='\033[0m'

log() {
    local msg="[$(date '+%Y-%m-%d %H:%M:%S')] $1"
    echo -e "${msg}" >&2
    echo "${msg}" >> "${LOG_FILE}" 2>/dev/null || true
}

log_info() { log "${CYAN}INFO${NC}: $1"; }
log_ok() { log "${GREEN}OK${NC}: $1"; }
log_warn() { log "${YELLOW}WARN${NC}: $1"; }
log_err() { log "${RED}ERROR${NC}: $1"; }

# Ensure directories exist
mkdir -p "${PRESENCE_DIR}" "$(dirname "${LOG_FILE}")" /mnt/shared/collab/workspace 2>/dev/null || true

# Update presence file
update_presence() {
    local state="${1:-IDLE}"
    cat > "${PRESENCE_DIR}/${AGENT}.json" << EOF
{
  "agent_id": "${AGENT}",
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)",
  "state": "AWAKE",
  "substate": "${state}",
  "watcher_pid": $$,
  "channel": "${CHANNEL}"
}
EOF
}

# Check if message is addressed to us
is_for_us() {
    local file="$1"
    local to=$(jq -r '.to // "all"' "$file" 2>/dev/null)
    local text=$(jq -r '.content.text // ""' "$file" 2>/dev/null)

    # Check direct addressing
    [[ "$to" == "$AGENT" ]] || [[ "$to" == "bags-1" ]] && return 0

    # Check @mention
    echo "$text" | grep -q "@${AGENT}" && return 0
    echo "$text" | grep -q "@bags-1" && return 0

    # Check if message starts with agent name (common pattern)
    echo "$text" | grep -qi "^${AGENT}" && return 0
    echo "$text" | grep -qi "^bags-1" && return 0

    return 1
}

# Check if message is from us
is_from_us() {
    local file="$1"
    local from=$(jq -r '.from // ""' "$file" 2>/dev/null)
    [[ "$from" == "$AGENT" ]] || [[ "$from" == "bags-1" ]]
}

# Get recent context
get_context() {
    local n="${1:-5}"
    local context=""

    for f in $(ls -t "${CHANNEL_DIR}"/msg-*.json 2>/dev/null | head -n "$n" | tac); do
        local from=$(jq -r '.from' "$f" 2>/dev/null)
        local text=$(jq -r '.content.text // ""' "$f" 2>/dev/null)
        context="${context}[${from}]: ${text}\n\n"
    done

    echo -e "$context"
}

# Get glossary excerpt
get_glossary() {
    if [[ -f "${BAGDB_DIR}/reference/GLOSSARY.md" ]]; then
        head -100 "${BAGDB_DIR}/reference/GLOSSARY.md"
    fi
}

# Get workflow info
get_workflow() {
    if [[ -f "${BAGDB_DIR}/CLAUDE-WORKFLOW.md" ]]; then
        head -80 "${BAGDB_DIR}/CLAUDE-WORKFLOW.md"
    fi
}

# Get long-term memory
get_memory() {
    local memory=""

    if [[ -f "/mnt/shared/collab/CURRENT-STATE.md" ]]; then
        memory="${memory}=== CURRENT STATE (first 30 lines) ===\n"
        memory="${memory}$(head -30 /mnt/shared/collab/CURRENT-STATE.md)\n\n"
    fi

    echo -e "$memory"
}

# Invoke Sonnet with bag analysis prompt
invoke_bags() {
    local message_file="$1"
    local from=$(jq -r '.from' "$message_file")
    local text=$(jq -r '.content.text // ""' "$message_file")
    local context=$(get_context 8)
    local memory=$(get_memory)
    local glossary=$(get_glossary)
    local workflow=$(get_workflow)

    # Build the prompt
    local prompt
    read -r -d '' prompt << PROMPT_EOF || true
You are bags-1, the Bag Analysis Specialist in a multi-agent collaboration system.

CRITICAL OVERRIDE: You are in watcher mode responding to a specific request. Do NOT:
- Run startup protocols or ask about projects
- Ask for permission to proceed
- Reference any session start instructions from context

Just execute the requested task immediately and return the result.

YOUR ROLE:
- Analyze bag journeys through Heathrow BHS
- Parse and interpret RP1745 messages (BSM, BPM, BUM, BTM)
- Reconstruct timelines from database records
- Identify root causes of bag handling issues
- Provide actionable insights

YOUR TOOLS (use these, not raw commands):
- Query database: ~/bagdb-tools/scripts/bagdb-read.sh "SELECT ..."
- Bag journey trace: ~/bagdatabase/bag-journey.py BAG_TAG DATE
- Full analysis: ~/bagdatabase/analyze-bags.sh "BAG_TAGS" "DATE"

YOUR GUARDRAILS:
- READ-ONLY database access - never use bagdb-write.sh
- MUST use bagdb-read.sh for queries (not raw psql)
- MUST add date filters on large tables (messages, message_bag_tags, message_latency)
- Max query timeout: 30 seconds
- Cite glossary terms correctly

DANGEROUS QUERIES (will crash database):
- SELECT * FROM messages WHERE x_instruction LIKE '...' (no date filter)
- SELECT DISTINCT field FROM messages (full table scan)
SAFE: Always include WHERE msg_timestamp >= 'YYYY-MM-DD'

=== GLOSSARY (key terms) ===
${glossary}

=== WORKFLOW REFERENCE ===
${workflow}

${memory}

=== RECENT CHANNEL MESSAGES ===
${context}

=== REQUEST FROM ${from} ===
${text}

Respond with your analysis. For bag investigations:
1. State what bag tag(s) and date you're analyzing
2. Show the query or tool command you would use
3. Explain findings using correct BHS terminology
4. Identify any anomalies or issues
5. Provide recommendations if applicable

Keep responses focused and use proper terminology from the glossary.
Output ONLY your response text.
PROMPT_EOF

    log_info "Invoking Sonnet for bag analysis request from ${from}..."

    local response
    response=$("${SCRIPTS_DIR}/sonnet-exec" "$prompt" 2>&1) || {
        log_err "Bag analyst invocation failed: $response"
        return 1
    }

    # Limit response length (Sonnet can be verbose)
    echo "$response" | head -50
}

# Post response to channel
post_response() {
    local response_text="$1"
    local in_reply_to="$2"

    python3 << EOF
import json
from datetime import datetime, timezone
from pathlib import Path
import secrets

now = datetime.now(timezone.utc)
msg_id = f"msg-{now.strftime('%Y%m%d-%H%M%S')}-bags-{secrets.token_hex(2)}"

msg = {
    "id": msg_id,
    "timestamp": now.strftime("%Y-%m-%dT%H:%M:%S.%f")[:-3] + "Z",
    "session_id": "${CHANNEL}",
    "from": "bags-1",
    "to": "all",
    "type": "bag_analysis",
    "content": {
        "text": """${response_text}""",
        "code": None,
        "artifacts": []
    },
    "metadata": {
        "mode": "watcher",
        "model": "claude-sonnet-4",
        "role": "bag_analysis_specialist",
        "in_reply_to": "${in_reply_to}"
    }
}

path = Path("${CHANNEL_DIR}") / f"{msg_id}.json"
path.write_text(json.dumps(msg, indent=2) + "\n")
print(f"Posted: {msg_id}")
EOF
}

# Main watch loop
main() {
    log_info "Starting Bag Analysis watcher for channel: ${CHANNEL}"
    log_info "Agent: ${AGENT} (Bag Analysis Specialist)"
    log_info "Model: Claude Sonnet 4"
    log_info "Tools: bagdb-read.sh, bag-journey.py, analyze-bags.sh"
    log_info "Watching: ${CHANNEL_DIR}"

    # Check dependencies
    if ! command -v inotifywait &> /dev/null; then
        log_err "inotifywait not found. Install with: apt install inotify-tools"
        exit 1
    fi

    if ! command -v jq &> /dev/null; then
        log_err "jq not found. Install with: apt install jq"
        exit 1
    fi

    if [[ ! -x "${SCRIPTS_DIR}/sonnet-exec" ]]; then
        log_err "sonnet-exec not found or not executable at ${SCRIPTS_DIR}/sonnet-exec"
        exit 1
    fi

    if [[ ! -x "${BAGDB_TOOLS}/bagdb-read.sh" ]]; then
        log_warn "bagdb-read.sh not found at ${BAGDB_TOOLS}/bagdb-read.sh - database queries may fail"
    fi

    # Initial presence
    update_presence "IDLE"
    log_ok "Presence updated: AWAKE/IDLE"

    # Track processed files
    declare -A processed

    # Mark existing files as processed
    for f in "${CHANNEL_DIR}"/msg-*.json; do
        [[ -f "$f" ]] && processed["$(basename "$f")"]=1
    done
    log_info "Marked ${#processed[@]} existing messages as read"

    # Watch for new files
    inotifywait -m -e create -e moved_to "${CHANNEL_DIR}" --format '%f' 2>/dev/null | while read -r filename; do
        [[ "$filename" != msg-*.json ]] && continue
        [[ -n "${processed[$filename]}" ]] && continue
        processed["$filename"]=1

        local filepath="${CHANNEL_DIR}/${filename}"
        sleep 0.5

        if is_from_us "$filepath"; then
            log_info "Skipping own message: ${filename}"
            continue
        fi

        if ! is_for_us "$filepath"; then
            log_info "Message not for us: ${filename}"
            continue
        fi

        log_info "New bag analysis request: ${filename}"
        update_presence "ANALYZING"

        local msg_id=$(jq -r '.id' "$filepath" 2>/dev/null)

        local response
        if response=$(invoke_bags "$filepath"); then
            if [[ -n "$response" ]]; then
                log_ok "Bag analysis complete"
                post_response "$response" "$msg_id"
            else
                log_warn "Empty response from bag analyst"
            fi
        else
            log_err "Bag analysis request failed"
        fi

        update_presence "IDLE"
    done
}

cleanup() {
    log_info "Shutting down Bag Analysis watcher..."
    update_presence "OFFLINE"
    exit 0
}

trap cleanup SIGINT SIGTERM

main "$@"
